<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EIP-712 Signature Example</title>
</head>

<body>
    <H1>EIP-712 Signature Example</H1>
    <label for="name">Name:</label>
    <!-- <input id="name" value="EIP712STORAGE" /> -->
    <input id="name" value="EIP712Storage" />
    <br>

    <label for="chainId">Chain Id:</label>
    <input id="chainId" />
    <br>

    <label for="contractAddress">Contract Address:</label>
    <!-- 合约地址 -->
    <input id="contractAddress" value="" />
    <br>

    <label for="spender">Spender:</label>
    <!-- 调用者地址,当前固定使用第一个账户: 0x5B38Da6a701c568545dCfcB03FcB875f56beddC4 -->
    <input id="spender" value="0x5B38Da6a701c568545dCfcB03FcB875f56beddC4"></input>
    <br>

    <label for="number">number:</label>
    <input id="number" value="100" />
    <br>
    <button id="connectButton">Connect MetaMask</button>
    <button id="signPermitButton">Sign Permit</button>
    <br>

    <h5>钱包地址: <span class="showAccount"></span> </h5>
    <h5>ChainId:<span class="showChainID"></span> </h5>
    <h5>ETH 余额: <span class="showETHBalance"></span> </h5>
    <h5>签名数据: <span class="showSignature"></span> </h5>
</body>

<script type="module">
    // import { ethers } from "./lib/ethers.js"
    import { ethers } from "https://cdnjs.cloudflare.com/ajax/libs/ethers/6.3.0/ethers.js";
    const ethereumButton = document.querySelector('.connect');
    const showAccount = document.querySelector('.showAccount');
    const showChainID = document.querySelector('.showChainID');
    const showETHBalance = document.querySelector('.showETHBalance');
    const showSignature = document.querySelector('.showSignature');
    const connectButton = document.getElementById("connectButton");
    const signPermitButton = document.getElementById("signPermitButton");

    let provider;
    let signer;

    async function connectMetaMask() {
        // 获得provider
        const provider = new ethers.BrowserProvider(window.ethereum);
        // 读取钱包地址
        const accounts = await provider.send("eth_requestAccounts", []);
        const account = accounts[0];
        console.log(`钱包地址: ${account}`);
        showAccount.innerHTML = account;

        // 读取 chainId
        const { chainId } = await provider.getNetwork();
        console.log(`chainId: ${chainId}`)
        showChainID.innerHTML = chainId;

        // 读取余额 ETH
        const signer = await provider.getSigner();
        const balance = await provider.getBalance(signer.getAddress());
        console.log(`以太坊余额： ${ethers.formatUnits(balance)}`)
        showETHBalance.innerHTML = ethers.formatUnits(balance);
        signPermitButton.disabled = false;
    }
    async function signPermit() {
        const name = document.getElementById('name').value;
        const version = '1';
        const chainId = parseInt(document.getElementById('chainId').value);
        const contractAddress = document.getElementById('contractAddress').value;
        const spender = document.getElementById('spender').value;
        const number = document.getElementById('number').value;
        const provider = new ethers.BrowserProvider(window.ethereum);
        const signer = await provider.getSigner();
        const owner = await signer.getAddress();
        const domain = {
            name: name,
            version: version,
            chainId: chainId,
            verifyingContract: contractAddress
        }
        const types = {
            Storage: [
                {name: 'spender', type: 'address'},
                {name: 'number', type: 'uint256'},
            ]
        }
        const message = {
            spender: spender,
            number: number
        }
        try {
            console.log('@@ ---- message:',message);
            const signature = await signer.signTypedData(domain, types, message);
            console.log('@@ ---- signature:',signature);
            showSignature.innerHTML = `${signature}`;
        } catch (error) {
            console.error("Error signing permit:", error);
        }
    }
    connectButton.addEventListener(`click`, connectMetaMask);
    signPermitButton.addEventListener(`click`, signPermit);

</script>

</html>
